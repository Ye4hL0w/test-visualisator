<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Interactif ColorScaleCalculator</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .test-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .test-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .test-panel:hover {
            transform: translateY(-2px);
        }

        .test-panel h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        .test-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        select, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }

        .config-display {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .palette-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .color-swatch {
            width: 50px;
            height: 50px;
            border: 2px solid white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            cursor: pointer;
            transition: transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .color-swatch:hover {
            transform: scale(1.1);
        }

        .result-info {
            background: #e8f4fd;
            border: 1px solid #b3d9ff;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }

        .result-info h4 {
            margin: 0 0 10px 0;
            color: #1a73e8;
        }

        .error {
            background: #ffe6e6;
            border: 1px solid #ffcccc;
            color: #d32f2f;
        }

        .success {
            background: #e8f5e8;
            border: 1px solid #c8e6c9;
            color: #2e7d32;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .log-panel {
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }

        .log-success { color: #2ecc71; }
        .log-warning { color: #f39c12; }
        .log-error { color: #e74c3c; }
        .log-info { color: #3498db; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üé® Test Interactif ColorScaleCalculator</h1>
        <p>Testez les diff√©rentes configurations ordinal et quantitative du nouveau syst√®me de couleurs</p>
    </div>

    <div class="test-container">
        <!-- Panel Ordinal -->
        <div class="test-panel">
            <h3>üî¢ Tests Ordinal</h3>
            <div class="test-controls">
                <select id="ordinal-test-select">
                    <option value="">-- Choisir un test --</option>
                </select>
                <button onclick="runOrdinalTest()">Ex√©cuter</button>
                <button onclick="clearOrdinalResult()">Clear</button>
            </div>
            
            <div class="config-display" id="ordinal-config">
                S√©lectionnez un test pour voir la configuration
            </div>
            
            <div class="palette-container" id="ordinal-palette">
                <!-- Palette ordinal appara√Ætra ici -->
            </div>
            
            <div class="result-info" id="ordinal-result">
                <h4>R√©sultat</h4>
                <p>Aucun test ex√©cut√©</p>
            </div>
        </div>

        <!-- Panel Quantitative -->
        <div class="test-panel">
            <h3>üìà Tests Quantitative</h3>
            <div class="test-controls">
                <select id="quantitative-test-select">
                    <option value="">-- Choisir un test --</option>
                </select>
                <button onclick="runQuantitativeTest()">Ex√©cuter</button>
                <button onclick="clearQuantitativeResult()">Clear</button>
            </div>
            
            <div class="config-display" id="quantitative-config">
                S√©lectionnez un test pour voir la configuration
            </div>
            
            <div class="palette-container" id="quantitative-palette">
                <!-- Palette quantitative appara√Ætra ici -->
            </div>
            
            <div class="result-info" id="quantitative-result">
                <h4>R√©sultat</h4>
                <p>Aucun test ex√©cut√©</p>
            </div>
        </div>
    </div>

    <!-- Stats globales -->
    <div class="stats">
        <div class="stat-card">
            <div class="stat-value" id="tests-run">0</div>
            <div>Tests ex√©cut√©s</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="tests-success">0</div>
            <div>Succ√®s</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="tests-failed">0</div>
            <div>√âchecs</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="schemas-tested">0</div>
            <div>Sch√©mas test√©s</div>
        </div>
    </div>

    <!-- Panel tests combin√©s -->
    <div class="test-panel full-width">
        <h3>üîÄ Tests Combin√©s et Cas Limites</h3>
        <div class="test-controls">
            <select id="combined-test-select">
                <option value="">-- Choisir un test --</option>
            </select>
            <button onclick="runCombinedTest()">Ex√©cuter</button>
            <button onclick="runAllEdgeCases()">Tester tous les cas limites</button>
        </div>
        
        <div class="config-display" id="combined-config">
            S√©lectionnez un test pour voir la configuration
        </div>
        
        <div id="combined-results">
            <!-- R√©sultats des tests combin√©s -->
        </div>
    </div>

    <!-- Console de logs -->
    <div class="log-panel">
        <h3 style="color: #ecf0f1; margin-top: 0;">üìã Console de Tests</h3>
        <div id="test-console">
            <div class="log-entry log-info">Console initialis√©e...</div>
        </div>
        <button onclick="clearConsole()" style="margin-top: 10px;">Vider Console</button>
    </div>

    <script type="module">
        import { ColorScaleCalculator } from '../components/ColorScaleCalculator.js';
        
        // Charger les configurations de test
        const testConfigs = await fetch('./color-scale-test-configs.json').then(r => r.json());
        
        // Initialiser le calculateur et les statistiques
        const calculator = new ColorScaleCalculator();
        window.calculator = calculator;
        
        let stats = {
            testsRun: 0,
            testsSuccess: 0,
            testsFailed: 0,
            schemasUsed: new Set()
        };

        // Logs color√©s
        function logToConsole(message, type = 'info') {
            const console = document.getElementById('test-console');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            console.appendChild(entry);
            console.scrollTop = console.scrollHeight;
        }

        function updateStats() {
            document.getElementById('tests-run').textContent = stats.testsRun;
            document.getElementById('tests-success').textContent = stats.testsSuccess;
            document.getElementById('tests-failed').textContent = stats.testsFailed;
            document.getElementById('schemas-tested').textContent = stats.schemasUsed.size;
        }

        // Populate selectors
        function populateSelectors() {
            const ordinalSelect = document.getElementById('ordinal-test-select');
            const quantitativeSelect = document.getElementById('quantitative-test-select');
            const combinedSelect = document.getElementById('combined-test-select');

            // Tests ordinaux
            Object.keys(testConfigs.ordinalTests).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = testConfigs.ordinalTests[key].description;
                ordinalSelect.appendChild(option);
            });

            // Tests quantitatifs
            Object.keys(testConfigs.quantitativeTests).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = testConfigs.quantitativeTests[key].description;
                quantitativeSelect.appendChild(option);
            });

            // Tests combin√©s
            Object.keys(testConfigs.combinedTests).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = testConfigs.combinedTests[key].description;
                combinedSelect.appendChild(option);
            });

            // Edge cases
            Object.keys(testConfigs.edgeCases).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = testConfigs.edgeCases[key].description;
                combinedSelect.appendChild(option);
            });
        }

        // Test une configuration de couleur
        function testColorScale(config, testName) {
            try {
                const colorConfig = config.nodes?.color || config.links?.color;
                if (!colorConfig) {
                    throw new Error('Aucune configuration de couleur trouv√©e');
                }

                // Simuler des donn√©es de test
                const domain = colorConfig.scale.domain || ['value1', 'value2', 'value3'];
                const dataKeys = domain;
                const range = colorConfig.scale.range;
                const scaleType = colorConfig.scale.type;

                logToConsole(`Test ${testName}: ${colorConfig.field} (${scaleType}) avec range: ${range}`, 'info');

                const result = calculator.createColorScale({
                    domain: domain,
                    range: range,
                    dataKeys: dataKeys,
                    scaleType: scaleType,
                    fallbackInterpolator: d3.interpolateTurbo,
                    label: testName
                });

                stats.testsRun++;
                stats.testsSuccess++;
                stats.schemasUsed.add(typeof range === 'string' ? range : 'custom');
                
                logToConsole(`‚úÖ Succ√®s: ${result.domain.length} couleurs g√©n√©r√©es`, 'success');
                return { success: true, result, config: colorConfig };

            } catch (error) {
                stats.testsRun++;
                stats.testsFailed++;
                logToConsole(`‚ùå Erreur: ${error.message}`, 'error');
                return { success: false, error: error.message, config: colorConfig };
            }
        }

        // Afficher une palette
        function displayPalette(containerId, result) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (!result.success) {
                container.innerHTML = `<div style="color: red; padding: 20px;">‚ùå ${result.error}</div>`;
                return;
            }

            const { domain, range } = result.result;
            domain.forEach((value, index) => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = range[index] || '#cccccc';
                swatch.textContent = index + 1;
                swatch.title = `${value}: ${range[index] || 'N/A'}`;
                
                // Click to copy color
                swatch.addEventListener('click', () => {
                    navigator.clipboard.writeText(range[index]);
                    logToConsole(`Couleur copi√©e: ${range[index]}`, 'info');
                });
                
                container.appendChild(swatch);
            });
        }

        // Event handlers
        window.runOrdinalTest = function() {
            const select = document.getElementById('ordinal-test-select');
            const testKey = select.value;
            if (!testKey) return;

            const config = testConfigs.ordinalTests[testKey];
            document.getElementById('ordinal-config').textContent = JSON.stringify(config, null, 2);
            
            const result = testColorScale(config, testKey);
            displayPalette('ordinal-palette', result);
            
            const resultDiv = document.getElementById('ordinal-result');
            resultDiv.className = `result-info ${result.success ? 'success' : 'error'}`;
            resultDiv.innerHTML = `
                <h4>${result.success ? '‚úÖ Succ√®s' : '‚ùå Erreur'}</h4>
                <p><strong>Test:</strong> ${testKey}</p>
                <p><strong>Type:</strong> ${result.config.scale.type}</p>
                <p><strong>Range:</strong> ${result.config.scale.range}</p>
                ${result.success ? 
                    `<p><strong>Couleurs g√©n√©r√©es:</strong> ${result.result.range.length}</p>` :
                    `<p><strong>Erreur:</strong> ${result.error}</p>`
                }
            `;
            
            updateStats();
        };

        window.runQuantitativeTest = function() {
            const select = document.getElementById('quantitative-test-select');
            const testKey = select.value;
            if (!testKey) return;

            const config = testConfigs.quantitativeTests[testKey];
            document.getElementById('quantitative-config').textContent = JSON.stringify(config, null, 2);
            
            const result = testColorScale(config, testKey);
            displayPalette('quantitative-palette', result);
            
            const resultDiv = document.getElementById('quantitative-result');
            resultDiv.className = `result-info ${result.success ? 'success' : 'error'}`;
            resultDiv.innerHTML = `
                <h4>${result.success ? '‚úÖ Succ√®s' : '‚ùå Erreur'}</h4>
                <p><strong>Test:</strong> ${testKey}</p>
                <p><strong>Type:</strong> ${result.config.scale.type}</p>
                <p><strong>Range:</strong> ${result.config.scale.range}</p>
                ${result.success ? 
                    `<p><strong>√âchelle:</strong> ${result.result.scale.constructor.name}</p>` :
                    `<p><strong>Erreur:</strong> ${result.error}</p>`
                }
            `;
            
            updateStats();
        };

        window.runCombinedTest = function() {
            const select = document.getElementById('combined-test-select');
            const testKey = select.value;
            if (!testKey) return;

            let config;
            if (testConfigs.combinedTests[testKey]) {
                config = testConfigs.combinedTests[testKey];
            } else if (testConfigs.edgeCases[testKey]) {
                config = testConfigs.edgeCases[testKey];
            }

            document.getElementById('combined-config').textContent = JSON.stringify(config, null, 2);
            
            const resultsDiv = document.getElementById('combined-results');
            resultsDiv.innerHTML = '<h4>R√©sultats:</h4>';
            
            // Tester nodes.color si pr√©sent
            if (config.nodes?.color) {
                const nodeResult = testColorScale({ nodes: { color: config.nodes.color } }, `${testKey}-nodes`);
                const nodeDiv = document.createElement('div');
                nodeDiv.className = `result-info ${nodeResult.success ? 'success' : 'error'}`;
                nodeDiv.innerHTML = `
                    <strong>Nodes Color:</strong> ${nodeResult.success ? '‚úÖ' : '‚ùå'}
                    ${nodeResult.success ? `(${nodeResult.result.range.length} couleurs)` : nodeResult.error}
                `;
                resultsDiv.appendChild(nodeDiv);
            }
            
            // Tester links.color si pr√©sent
            if (config.links?.color) {
                const linkResult = testColorScale({ links: { color: config.links.color } }, `${testKey}-links`);
                const linkDiv = document.createElement('div');
                linkDiv.className = `result-info ${linkResult.success ? 'success' : 'error'}`;
                linkDiv.innerHTML = `
                    <strong>Links Color:</strong> ${linkResult.success ? '‚úÖ' : '‚ùå'}
                    ${linkResult.success ? `(${linkResult.result.range.length} couleurs)` : linkResult.error}
                `;
                resultsDiv.appendChild(linkDiv);
            }
            
            updateStats();
        };

        window.runAllEdgeCases = function() {
            logToConsole('=== D√©but des tests de cas limites ===', 'info');
            
            Object.keys(testConfigs.edgeCases).forEach(testKey => {
                const config = testConfigs.edgeCases[testKey];
                logToConsole(`Test cas limite: ${testKey}`, 'info');
                testColorScale(config, testKey);
            });
            
            logToConsole('=== Fin des tests de cas limites ===', 'info');
            updateStats();
        };

        window.clearOrdinalResult = function() {
            document.getElementById('ordinal-palette').innerHTML = '';
            document.getElementById('ordinal-result').innerHTML = '<h4>R√©sultat</h4><p>Aucun test ex√©cut√©</p>';
        };

        window.clearQuantitativeResult = function() {
            document.getElementById('quantitative-palette').innerHTML = '';
            document.getElementById('quantitative-result').innerHTML = '<h4>R√©sultat</h4><p>Aucun test ex√©cut√©</p>';
        };

        window.clearConsole = function() {
            document.getElementById('test-console').innerHTML = '<div class="log-entry log-info">Console vid√©e...</div>';
        };

        // Event listeners pour mise √† jour automatique des configs
        document.getElementById('ordinal-test-select').addEventListener('change', function() {
            if (this.value) {
                const config = testConfigs.ordinalTests[this.value];
                document.getElementById('ordinal-config').textContent = JSON.stringify(config, null, 2);
            }
        });

        document.getElementById('quantitative-test-select').addEventListener('change', function() {
            if (this.value) {
                const config = testConfigs.quantitativeTests[this.value];
                document.getElementById('quantitative-config').textContent = JSON.stringify(config, null, 2);
            }
        });

        document.getElementById('combined-test-select').addEventListener('change', function() {
            if (this.value) {
                let config;
                if (testConfigs.combinedTests[this.value]) {
                    config = testConfigs.combinedTests[this.value];
                } else if (testConfigs.edgeCases[this.value]) {
                    config = testConfigs.edgeCases[this.value];
                }
                document.getElementById('combined-config').textContent = JSON.stringify(config, null, 2);
            }
        });

        // Initialisation
        populateSelectors();
        updateStats();
        logToConsole('üé® ColorScaleCalculator Test Suite charg√© !', 'success');
        logToConsole('Commencez par s√©lectionner un test dans les menus d√©roulants', 'info');
        
        // Exposer pour debugging
        window.testConfigs = testConfigs;
        console.log('Test configs loaded:', testConfigs);
    </script>
</body>
</html> 